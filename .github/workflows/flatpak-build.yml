name: Build and Auto-Update Flatpak

on:
  schedule:
    - cron: '0 0 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  flatpak:
    name: Build Anycubic Slicer
    runs-on: ubuntu-latest
    container:
      image: bilelmoussaoui/flatpak-github-actions:gnome-47
      options: --privileged

    steps:
      - uses: actions/checkout@v4

      - name: Install JQ
        run: |
          # Containern kör ofta Fedora/Alpine, men den här är baserad på en miljö där vi kan hämta jq
          # Om dnf inte finns, testar vi att bara ladda ner binären direkt för att vara 100% säkra
          curl -L -o /usr/bin/jq https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux-amd64
          chmod +x /usr/bin/jq

      - name: Check for Updates from Anycubic Repo
        id: updater
        run: |
          curl -s https://cdn-universe-slicer.anycubic.com/prod/dists/noble/main/binary-amd64/Packages > Packages
          
          REMOTE_VERSION=$(grep "^Version:" Packages | tail -n 1 | awk '{print $2}')
          REMOTE_PATH=$(grep "^Filename:" Packages | tail -n 1 | awk '{print $2}')
          REMOTE_SHA=$(grep "^SHA256:" Packages | tail -n 1 | awk '{print $2}')
          FULL_URL="https://cdn-universe-slicer.anycubic.com/prod/$REMOTE_PATH"
          
          # Hämta nuvarande version från manifestet
          CURRENT_VERSION=$(jq -r '.branch // "0"' com.anycubic.AnycubicSlicer.json)
          
          echo "Current local version: $CURRENT_VERSION"
          echo "Latest remote version: $REMOTE_VERSION"
          
          if [ "$REMOTE_VERSION" != "$CURRENT_VERSION" ]; then
            echo "New version found! Updating manifest..."
            jq --arg ver "$REMOTE_VERSION" \
               --arg url "$FULL_URL" \
               --arg sha "$REMOTE_SHA" \
               '.modules[0].sources[0].url = $url | .modules[0].sources[0].sha256 = $sha | .branch = $ver | .modules[0].sources[0].type = "file"' \
               com.anycubic.AnycubicSlicer.json > temp.json && mv temp.json com.anycubic.AnycubicSlicer.json
            echo "update_needed=true" >> $GITHUB_OUTPUT
          else
            echo "Already up to date."
            echo "update_needed=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Build Flatpak
        if: steps.updater.outputs.update_needed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

          # 1. Bygg appen
          flatpak-builder --repo=repo --force-clean --install-deps-from=flathub build-dir com.anycubic.AnycubicSlicer.json

          # 2. Hämta branchen dynamiskt från manifestet
          APP_BRANCH=$(jq -r '.branch // "master"' com.anycubic.AnycubicSlicer.json)

          # 3. Skapa bundlen med rätt branch
          flatpak build-bundle repo anycubic-slicer.flatpak com.anycubic.AnycubicSlicer "$APP_BRANCH"

      - name: Upload Artifact
        if: steps.updater.outputs.update_needed == 'true' || github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: anycubic-slicer-bundle
          path: anycubic-slicer.flatpak

      - name: Commit Updated Manifest
        if: steps.updater.outputs.update_needed == 'true'
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add com.anycubic.AnycubicSlicer.json
          UPDATED_VER=$(jq -r '.branch' com.anycubic.AnycubicSlicer.json)
          git commit -m "Auto-update to version $REMOTE_VERSION" || echo "No changes to commit"
          git push
