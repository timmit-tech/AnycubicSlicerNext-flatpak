name: Build and Auto-Update Flatpak

on:
  schedule:
    - cron: '0 0 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  flatpak:
    name: Build Anycubic Slicer
    runs-on: ubuntu-latest
    container:
      image: bilelmoussaoui/flatpak-github-actions:gnome-47
      options: --privileged

    steps:
      - uses: actions/checkout@v4

      - name: Install JQ
        run: |
          curl -L -o /usr/bin/jq https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux-amd64
          chmod +x /usr/bin/jq

      - name: Check for Updates from Anycubic Repo
        id: updater
        run: |
          curl -s https://cdn-universe-slicer.anycubic.com/prod/dists/noble/main/binary-amd64/Packages > Packages
          
          REMOTE_VERSION=$(grep "^Version:" Packages | tail -n 1 | awk '{print $2}')
          REMOTE_PATH=$(grep "^Filename:" Packages | tail -n 1 | awk '{print $2}')
          REMOTE_SHA=$(grep "^SHA256:" Packages | tail -n 1 | awk '{print $2}')
          FULL_URL="https://cdn-universe-slicer.anycubic.com/prod/$REMOTE_PATH"
          
          CURRENT_VERSION=$(jq -r '.branch // "0"' com.anycubic.AnycubicSlicer.json)
          
          echo "Current local version: $CURRENT_VERSION"
          echo "Latest remote version: $REMOTE_VERSION"
          
          # Exportera versionen så andra steg kan använda den
          echo "remote_version=$REMOTE_VERSION" >> $GITHUB_OUTPUT
          
          if [ "$REMOTE_VERSION" != "$CURRENT_VERSION" ]; then
            echo "New version found! Updating manifest..."
            jq --arg ver "$REMOTE_VERSION" \
               --arg url "$FULL_URL" \
               --arg sha "$REMOTE_SHA" \
               '.modules[0].sources[0].url = $url | .modules[0].sources[0].sha256 = $sha | .branch = $ver | .modules[0].sources[0].type = "file"' \
               com.anycubic.AnycubicSlicer.json > temp.json && mv temp.json com.anycubic.AnycubicSlicer.json
            echo "update_needed=true" >> $GITHUB_OUTPUT
          else
            echo "Already up to date."
            echo "update_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Build Flatpak
        if: steps.updater.outputs.update_needed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          flatpak-builder --repo=repo --force-clean --install-deps-from=flathub build-dir com.anycubic.AnycubicSlicer.json
          
          # Hämta version och skapa filnamn
          VERSION="${{ steps.updater.outputs.remote_version }}"
          FILENAME="anycubic-slicer-$VERSION.flatpak"
          
          flatpak build-bundle repo "$FILENAME" com.anycubic.AnycubicSlicer "$VERSION"
          
          # Spara filnamnet till miljövariabler för senare steg
          echo "BUNDLE_FILENAME=$FILENAME" >> $GITHUB_ENV

      - name: Upload Artifact
        if: steps.updater.outputs.update_needed == 'true' || github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: anycubic-slicer-${{ steps.updater.outputs.remote_version }}
          path: ${{ env.BUNDLE_FILENAME }}

      - name: Create Release
        if: steps.updater.outputs.update_needed == 'true' || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.updater.outputs.remote_version }}
          name: Anycubic Slicer Next v${{ steps.updater.outputs.remote_version }}
          body: |
            Automatisk paketering av Anycubic Slicer Next.
            Version: `${{ steps.updater.outputs.remote_version }}`
          files: ${{ env.BUNDLE_FILENAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit Updated Manifest
        if: steps.updater.outputs.update_needed == 'true'
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add com.anycubic.AnycubicSlicer.json
          git commit -m "Auto-update to version ${{ steps.updater.outputs.remote_version }}" || echo "No changes to commit"
          git push
