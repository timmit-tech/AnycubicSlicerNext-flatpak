name: Build and Auto-Update Flatpak

on:
  schedule:
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  check-and-build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check for Updates from Anycubic Repo
        id: updater
        run: |
          curl -s https://cdn-universe-slicer.anycubic.com/prod/dists/noble/main/binary-amd64/Packages > Packages
          
          REMOTE_VERSION=$(grep "^Version:" Packages | tail -n 1 | awk '{print $2}')
          REMOTE_PATH=$(grep "^Filename:" Packages | tail -n 1 | awk '{print $2}')
          REMOTE_SHA=$(grep "^SHA256:" Packages | tail -n 1 | awk '{print $2}')
          FULL_URL="https://cdn-universe-slicer.anycubic.com/prod/$REMOTE_PATH"
          
          CURRENT_VERSION=$(jq -r '.branch' com.anycubic.AnycubicSlicer.json)
          
          echo "Current local version: $CURRENT_VERSION"
          echo "Latest remote version: $REMOTE_VERSION"
          
          if [ "$REMOTE_VERSION" != "$CURRENT_VERSION" ]; then
            echo "New version found! Updating manifest..."
            jq --arg ver "$REMOTE_VERSION" \
               --arg url "$FULL_URL" \
               --arg sha "$REMOTE_SHA" \
               '.modules[0].sources[0].url = $url | .modules[0].sources[0].sha256 = $sha | .branch = $ver | .modules[0].sources[0].type = "file"' \
               com.anycubic.AnycubicSlicer.json > temp.json && mv temp.json com.anycubic.AnycubicSlicer.json
            echo "update_needed=true" >> $GITHUB_OUTPUT
          else
            echo "Already up to date."
            echo "update_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Build Flatpak
        if: steps.updater.outputs.update_needed == 'true' || github.event_name == 'workflow_dispatch'
        uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        with:
          bundle: anycubic-slicer.flatpak
          manifest: com.anycubic.AnycubicSlicer.json
          cache: true
          arch: x86_64
          # Vi anger runtimen här för att säkerställa kompatibilitet
          runtime-version: "47"

      - name: Upload Artifact
        if: steps.updater.outputs.update_needed == 'true' || github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: anycubic-slicer-bundle
          path: anycubic-slicer.flatpak

      - name: Commit Updated Manifest
        if: steps.updater.outputs.update_needed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add com.anycubic.AnycubicSlicer.json
          git commit -m "Auto-update to version $(jq -r '.branch' com.anycubic.AnycubicSlicer.json)"
          git push
